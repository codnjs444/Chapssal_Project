<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
	<style>
		body {
		    background-color: #000;
		    color: #fff;
		    overflow: hidden;
		}
		.video-container {
		    display: flex;
		    height: 100vh;
		    position: relative;
		}
		.video-section {
		    flex: 3;
		    display: flex;
		    justify-content: center;
		    align-items: center;
		    position: relative;
		}
		.video-section video {
		    max-width: 100%;
		    max-height: 100%;
		}
		.info-section {
		    flex: 1;
		    padding: 20px;
		    overflow-y: auto;
		    background-color: #fff;
		    color: #000;
		    position: relative;
		}
		.profile-section, .comments-section {
		    background-color: #f9f9f9;
		    padding: 10px;
		    border-radius: 10px;
		    margin-bottom: 20px;
		}
		.profile-section .follow-btn {
		    color: #fff;
		    background-color: #ff0050;
		    border: none;
		    padding: 5px 20px; /* 버튼 길이 조정 */
		    border-radius: 5px;
		    margin-left: auto;
		}
		.comments-section h6 {
		    margin-bottom: 10px;
		}
		.comments-section {
		    max-height: calc(100vh - 250px); /* 댓글 영역의 최대 높이 설정 */
		    overflow-y: auto; /* 스크롤 가능하도록 설정 */
		}
		.close-btn, .navigation-btns {
		    position: absolute;
		    top: 20px;
		    right: 20px;
		    z-index: 1000;
		}
		.navigation-btns {
		    top: 50%;
		    right: 20px;
		    transform: translateY(-50%);
		}
		.navigation-btns button {
		    background: none;
		    border: none;
		    color: white;
		    font-size: 24px;
		    display: block;
		    margin: 10px 0;
		}
		.profile-section img {
		    width: 40px; /* 프로필 사진 크기를 줄입니다 */
		    height: 40px; /* 프로필 사진 크기를 줄입니다 */
		}
		.profile-info-container {
		    display: flex;
		    align-items: center;
		    flex-grow: 1;
		    margin-left: 10px; /* 이름을 이미지 옆에 가깝게 배치 */
		}
		.profile-section h5 {
		    font-size: 1rem; /* 이름 크기 조절 */
		    margin-bottom: 0;
		}
		.profile-section small {
		    display: block; /* 학교를 이름 아래에 표시 */
		    font-size: 0.8rem; /* 학교 이름 크기 조절 */
		    color: #6c757d; /* 학교 이름 색상 조절 */
		}
		.comment-input-container {
		    display: flex;
		    align-items: center;
		    padding: 5px;
		    background-color: #f9f9f9;
		    border-radius: 10px;
		    box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
		    position: absolute;
		    bottom: 10px;
		    right: 10px;
		    width: calc(100% - 40px); /* 전체 너비에서 좌우 마진을 고려한 너비 설정 */
			z-index: 1000; /* z-index 추가 */
		}

		.comment-input {
		    flex-grow: 1;
		    border: none;
		    padding: 8px 10px;
		    border-radius: 10px;
		    background-color: #e9ecef;
		    margin-right: 5px;
		}
		.comment-input:focus {
		    outline: none;
		}
		.submit-comment-btn {
		    background-color: transparent;
		    color: #007bff;
		    border: none;
		    cursor: pointer;
		    padding: 0 10px;
		}
		.profile-section .options-btn, .options-dropdown {
		    position: relative;
		    display: inline-block;
		}
		.options-dropdown {
		    display: none;
		    position: absolute;
		    top: 30px;
		    right: 0;
		    background-color: #fff;
		    color: #000;
		    border: 1px solid #ccc;
		    border-radius: 5px;
		    z-index: 1000;
		    white-space: nowrap; /* 가로로 배치되도록 설정 */
		    padding: 5px; /* 드롭다운 메뉴 전체의 여백 추가 */
		}
		.options-dropdown button {
		    display: inline-block; /* 항목을 가로로 배치 */
		    border: none;
		    background: none;
		    padding: 10px; /* 항목의 내부 여백 조정 */
		    cursor: pointer;
		    color: #000;
		    font-size: 16px;
		    margin: 0 5px; /* 항목 사이 여백 추가 */
		}
		.comment-item strong {
		    font-size: 13px; /* 사용자 이름 폰트 크기 */
		}
		.comment-item p {
		    font-size: 12px; /* 댓글 내용 폰트 크기 */
		    margin: 0px 0; /* 댓글 내용과 날짜 사이의 간격 줄임 */
		}
		.comment-item small {
		    font-size: 10px; /* 날짜 폰트 크기 */
		    color: #6c757d; /* 날짜 색상 */
		    margin-top: 2px; /* 날짜와 텍스트 간의 간격 줄임 */
		}
		.icon-section {
		    position: absolute;
		    right: 20px;
		    top: 50%;
		    transform: translateY(-50%);
		    text-align: center;
		    color: white;
		}
		.icon-section button {
		    background: none;
		    border: none;
		    color: white;
		    font-size: 24px;
		    display: block;
		    margin: 10px 0;
		}
		.icon-section span {
		    display: block;
		    font-size: 14px;
		    margin-top: 5px;
		}
		.comment-item {
		       display: flex;
		       align-items: center;
		       margin-bottom: 15px; /* 댓글 간의 간격을 넓힘 */
		       justify-content: space-between; /* 아이템을 양쪽 끝으로 배치 */
		   }
		   .comment-item img {
		       width: 40px;
		       height: 40px;
		       border-radius: 50%;
		       margin-right: 10px;
		       cursor: pointer; /* 프로필 사진 클릭 가능하도록 커서 변경 */
		   }
		   .comment-item .comment-body {
		       flex-grow: 1;
		       display: flex;
		       flex-direction: column;
		       justify-content: center;
		       cursor: pointer; /* 프로필 사진 클릭 가능하도록 커서 변경 */
		   }
		   .comment-item .comment-actions {
		       display: flex;
		       align-items: center;
		   }
		   .comment-item .comment-actions button {
		       background: none;
		       border: none;
		       color: #000;
		       cursor: pointer;
		       font-size: 14px;
		       margin-left: 10px;
		   }
		   .comment-item .comment-actions span {
		       font-size: 12px;
		       color: #6c757d;
		       margin-left: 5px;
		   }
		   .comment-item strong {
		       font-size: 13px; /* 사용자 이름 폰트 크기 */
		   }
		   .comment-item p {
		       font-size: 12px; /* 댓글 내용 폰트 크기 */
		       margin: 0px 0; /* 댓글 내용과 날짜 사이의 간격 줄임 */
		   }
		   .comment-item small {
		       font-size: 10px; /* 날짜 폰트 크기 */
		       color: #6c757d; /* 날짜 색상 */
		       margin-top: 2px; /* 날짜와 텍스트 간의 간격 줄임 */
		   }
	 </style>
</head>
<body>
    <div class="video-container">
        <div class="video-section"> 
            <video controls autoplay>
                <source th:src="${videoUrl}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
			<button class="close-btn btn btn-outline-light" id="closeButton" onclick="navigateToProfile()">
			    <i class="bi bi-x"></i>
			</button>
			<div class="navigation-btns">
			    <button th:onclick="'navigateVideo(' + ${nextVideoNum} + ', ' + ${videoUser.userNum} + ')'" th:disabled="${nextVideoNum} == 0">
			        <i class="bi bi-chevron-up"></i>
			    </button>
			    <button th:onclick="'navigateVideo(' + ${prevVideoNum} + ', ' + ${videoUser.userNum} + ')'" th:disabled="${prevVideoNum} == 0">
			        <i class="bi bi-chevron-down"></i>
			    </button>
			</div>
        </div>
        <div class="info-section">
            <div class="profile-section">
				<div class="d-flex align-items-center mb-2">
				    <img th:src="${profilePictureUrl != null ? profilePictureUrl : '/images/default_profile.png'}" class="rounded-circle" alt="프로필 사진" th:onclick="|navigateToProfilePage(${userNum}, ${currentUserNum})|">
				    <div class="profile-info-container" th:onclick="|navigateToProfilePage(${userNum}, ${currentUserNum})|">
				        <div>
				            <h5 th:text="${userName != null ? userName : '사용자'}" th:onclick="|navigateToProfilePage(${userNum}, ${currentUserNum})|"></h5>
				            <small th:text="${schoolName}" th:onclick="|navigateToProfilePage(${userNum}, ${currentUserNum})|"></small>
				        </div>
				    </div>
					<button type="button"
					        th:if="${currentUserNum} != ${userNum}"
					        th:classappend="${isFollowing} ? 'btn btn-outline-secondary btn-sm' : 'btn btn-primary btn-sm text-white'"
					        th:attr="onclick=|followUser('${currentUserNum}', '${userNum}', '${isFollowing}')|">
					    <i th:classappend="${isFollowing} ? 'bi bi-check2' : ''"></i>
					    <span th:text="${isFollowing} ? '팔로잉' : '팔로우'"></span>
					</button>
					<div th:if="${currentUserNum} == ${userNum}" class="position-relative">
					    <button class="options-btn btn btn-outline-secondary btn-sm" onclick="toggleOptions()">
					        <i class="bi bi-three-dots"></i>
					    </button>
					    <div class="options-dropdown">
					        <button onclick="shareVideo()">공유하기</button>
					        <button onclick="confirmDelete()">삭제하기</button>
					    </div>
					</div>
				</div>
				<p th:text="${videoTitle}"></p>
<!--                <a href="#" class="text-muted">자세히</a>-->
			<div class="d-flex justify-content-around mt-3">
			    <div class="d-flex align-items-center">
			        <button type="button" class="btn btn-link" 
			                th:classappend="${isLiked} ? 'text-danger' : 'text-muted'"
			                th:attr="onclick=|likeVideo(${videoNum}, ${currentUserNum}, '${isLiked}')|">
			            <i th:classappend="${isLiked} ? 'bi bi-heart-fill' : 'bi bi-heart'"></i>
			        </button>
			        <span class="like-count ms-0" th:text="${likeCount}"></span> <!-- 좋아요 수 표시, 더 가까이 위치 -->
			    </div>
				<div class="d-flex align-items-center">
				    <div><i class="bi bi-chat"></i> <span th:text="${commentCount}"></span></div>
				</div>
				<div class="d-flex align-items-center">
				    <div><i class="bi bi-share"></i> 593</div>
				</div>
			</div>
			
            </div>
			<!-- 댓글 섹션 HTML -->
			<div class="comments-section">
			    <h6>댓글</h6>
				<div th:each="comment : ${comments}" class="comment-item" th:data-comment-num="${comment.commentNum}" th:data-user-num="${comment.user.userNum}">
				    <img th:src="${comment.user.profilePictureUrl != null ? comment.user.profilePictureUrl : '/images/default_profile.png'}" 
				         alt="사용자 사진" 
				         th:onclick="|navigateToProfilePage(${comment.user.userNum}, ${currentUserNum})|">
				    <div class="comment-body" th:onclick="|navigateToProfilePage(${comment.user.userNum}, ${currentUserNum})|">
				        <strong th:text="${comment.user.userName}">사용자 이름</strong>
				        <p th:text="${comment.text}">댓글 내용</p>
				        <small class="comment-date" th:text="${#temporals.format(comment.date, 'yyyy-MM-dd HH:mm:ss')}">날짜</small>
				    </div>
				    <div class="comment-actions">
						<button th:attr="onclick=|likeComment(${comment.commentNum}, ${currentUserNum})|">
						    <i class="bi" th:classappend="${comment.liked} ? 'bi-heart-fill text-danger' : 'bi-heart'"></i>
						</button>
						<span th:text="${comment.likeCount}"></span> <!-- 좋아요 수 표시 -->
				    </div>
				</div>
			    <p hidden>Video Number: <span id="videoNumDisplay" th:text="${videoNum}"></span></p>
			</div>
			<!-- 추가 댓글 아이템 -->
			<div class="comment-input-container">
			    <input type="hidden" name="videoNum" id="videoNum" value="${videoNum}">
			    <input type="hidden" name="currentUserNum" id="currentUserNum" value="${currentUserNum}">
			    <input type="text" class="comment-input" name="commentText" id="commentText" placeholder="따뜻한 말 한마디 해주세요...">
			    <button type="button" class="submit-comment-btn" onclick="submitComment()">게시</button>
			</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
	<script th:inline="javascript">
	    /*<![CDATA[*/
		
		document.addEventListener('DOMContentLoaded', function() {
		    const videoNum = /*[[${videoNum}]]*/ '[[${videoNum}]]';
		    console.log('Video Number:', videoNum);
		    document.getElementById('videoNumDisplay').textContent = videoNum;
		});
		
	    function followUser(currentUserNum, userNum, isFollowing) {
	        console.log("followUser 함수 호출됨");

	        if (isFollowing === 'true') {
	            if (!confirm('팔로우를 취소하시겠습니까?')) {
	                return;
	            }
	        }

	        let url = isFollowing === 'true' ? '/follow/unfollow' : '/follow';
	        let method = isFollowing === 'true' ? 'DELETE' : 'POST';

	        fetch(url, {
	            method: method,
	            headers: {
	                'Content-Type': 'application/json'
	            },
	            body: JSON.stringify({
	                follower: currentUserNum,
	                following: userNum
	            })
	        })
	        .then(response => response.json())
	        .then(data => {
	            if (data.success) {
	                location.reload();
	            } else {
	                alert('작업 실패: ' + data.message);
	            }
	        })
	        .catch(error => {
	            console.error('Error:', error);
	            alert('작업 중 오류가 발생했습니다.');
	        });
	    }

		document.addEventListener('DOMContentLoaded', function() {
		    const videoNum = /*[[${videoNum}]]*/ '[[${videoNum}]]';
		    console.log('Video Number:', videoNum);
		    document.getElementById('videoNumDisplay').textContent = videoNum;

		    // 댓글 날짜를 오늘 기준으로 몇일 전인지 계산하여 표시
		    const commentDates = document.querySelectorAll('.comment-date');
		    const now = new Date();

		    commentDates.forEach(dateElement => {
		        const commentDate = new Date(dateElement.textContent);
		        const diffTime = Math.abs(now - commentDate);
		        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

		        // diffDays를 하루 더하여 날짜를 계산
		        const adjustedDiffDays = diffDays - 1;

		        if (adjustedDiffDays === 0) {
		            dateElement.textContent = '오늘';
		        } else if (adjustedDiffDays === 1) {
		            dateElement.textContent = '어제';
		        } else {
		            dateElement.textContent = `${adjustedDiffDays}일 전`;
		        }
		    });
		});


		
	    function likeVideo(videoNum, currentUserNum, isLiked) {
	        console.log("likeVideo 함수 호출됨");

	        let url = isLiked === 'true' ? '/video/unlike' : '/video/like';
	        let method = isLiked === 'true' ? 'DELETE' : 'POST';

	        fetch(url, {
	            method: method,
	            headers: {
	                'Content-Type': 'application/json'
	            },
	            body: JSON.stringify({
	                video: videoNum,
	                user: currentUserNum
	            })
	        })
	        .then(response => response.json())
	        .then(data => {
	            if (data.success) {
	                location.reload();
	            } else {
	                alert('작업 실패: ' + data.message);
	            }
	        })
	        .catch(error => {
	            console.error('Error:', error);
	            alert('작업 중 오류가 발생했습니다.');
	        });
	    }

	    function navigateVideo(videoNum, userNum) {
	        // 이 함수는 주어진 비디오 번호와 사용자 번호로 이동합니다.
	        if (videoNum === 0) {
	            alert("더 이상의 영상이 없습니다.");
	        } else {
	            window.location.href = '/video/' + videoNum + '?userNum=' + userNum;
	        }
	    }

		function navigateToProfile() {
		    // 사용자의 프로필 페이지로 이동합니다.
		    const userNum = /*[[${videoUser.userNum}]]*/ [[${videoUser.userNum}]];
		    const currentUserNum = /*[[${currentUserNum}]]*/ [[${currentUserNum}]];
		    
		    if (userNum === currentUserNum) {
		        window.location.href = 'http://localhost:8080/user/profile';
		    } else {
		        window.location.href = 'http://localhost:8080/user/profile/' + userNum;
		    }
		}


		function navigateToProfilePage(userNum, currentUserNum) {
		    // 사용자의 프로필 페이지로 이동합니다.
		    if (userNum === currentUserNum) {
		        window.location.href = 'http://localhost:8080/user/profile';
		    } else {
		        window.location.href = 'http://localhost:8080/user/profile/' + userNum;
		    }
		}

	    document.addEventListener('keydown', function(event) {
	        if (event.key === 'ArrowUp') {
	            // 위 방향키를 누르면 이전 비디오로 이동
	            navigateVideo(/*[[${prevVideoNum}]]*/ '[[${prevVideoNum}]]', /*[[${videoUser.userNum}]]*/ '[[${videoUser.userNum}]]');
	        } else if (event.key === 'ArrowDown') {
	            // 아래 방향키를 누르면 다음 비디오로 이동
	            navigateVideo(/*[[${nextVideoNum}]]*/ '[[${nextVideoNum}]]', /*[[${videoUser.userNum}]]*/ '[[${videoUser.userNum}]]');
	        } else if (event.key === 'Escape') {
	            // Esc 키를 누르면 프로필 페이지로 이동
	            navigateToProfile();
	        }
	    });
		
		document.addEventListener('DOMContentLoaded', function() {
		    const videoNum = /*[[${videoNum}]]*/ '[[${videoNum}]]';
		    const currentUserNum = /*[[${currentUserNum}]]*/ '[[${currentUserNum}]]';
		    console.log('Video Number:', videoNum);
		    console.log('Current User Number:', currentUserNum);
		    document.getElementById('videoNumDisplay').textContent = videoNum;
		    document.getElementById('videoNum').value = videoNum;
		    document.getElementById('currentUserNum').value = currentUserNum;
		});

		function submitComment() {
		    const commentText = document.getElementById('commentText').value;
		    const videoNum = document.getElementById('videoNum').value;
		    const currentUserNum = document.getElementById('currentUserNum').value;

		    if (commentText.trim() === "") {
		        alert("댓글을 입력하세요.");
		        return;
		    }

		    const comment = {
		        text: commentText,
		        video: { videoNum: parseInt(videoNum, 10) },
		        user: { userNum: parseInt(currentUserNum, 10) }
		    };

		    console.log('Sending comment:', comment);

		    fetch('/comment/add', {
		        method: 'POST',
		        headers: {
		            'Content-Type': 'application/json'
		        },
		        body: JSON.stringify(comment)
		    })
		    .then(response => response.text()) // 응답을 텍스트로 처리
		    .then(text => {
		        console.log('Response text:', text);
		        if (text.trim() === 'success') {
		            location.reload();
		        } else {
		            alert('댓글 등록 실패: ' + text);
		        }
		    })
		    .catch(error => {
		        console.error('Error:', error);
		        alert('댓글 등록 중 오류가 발생했습니다.');
		    });
		}
		function toggleOptions() {
		    const optionsDropdown = document.querySelector('.options-dropdown');
		    optionsDropdown.style.display = optionsDropdown.style.display === 'block' ? 'none' : 'block';
		}

		function confirmDelete() {
		    if (confirm("정말 삭제하시겠습니까?")) {
		        deleteVideo();
		    }
		}

		function deleteVideo() {
		    const videoNum = document.getElementById('videoNum').value;
		    console.log('Deleting video with number:', videoNum); // 디버깅용 로그 추가

		    fetch(`/video/delete/${videoNum}`, {
		        method: 'DELETE',
		        headers: {
		            'Content-Type': 'application/json'
		        }
		    })
		    .then(response => response.json())
		    .then(data => {
		        if (data.success) {
		            alert('비디오가 삭제되었습니다.');
		            window.location.href = '/user/profile'; // 삭제 후 프로필 페이지로 이동
		        } else {
		            alert('비디오 삭제 실패: ' + data.message);
		        }
		    })
		    .catch(error => {
		        console.error('Error:', error);
		        alert('비디오 삭제 중 오류가 발생했습니다.');
		    });
		}
		function navigateToProfilePage(userNum, currentUserNum) {
		    // 사용자의 프로필 페이지로 이동합니다.
		    if (userNum === currentUserNum) {
		        window.location.href = 'http://localhost:8080/user/profile';
		    } else {
		        window.location.href = 'http://localhost:8080/user/profile/' + userNum;
		    }
		}
		
		function likeComment(commentNum, currentUserNum) {
		    // 댓글 정보를 가져오기
		    const commentElement = document.querySelector(`.comment-item[data-comment-num="${commentNum}"]`);

		    // 현재 좋아요 상태 가져오기
		    const likeIcon = commentElement.querySelector('.bi');
		    const isLiked = likeIcon.classList.contains('bi-heart-fill');

		    // 서버로 데이터 전송
		    fetch('/comment/like', {
		        method: 'POST',
		        headers: {
		            'Content-Type': 'application/json'
		        },
		        body: JSON.stringify({
		            commentNum: commentNum,
		            currentUserNum: currentUserNum,
		            likeDate: new Date().toISOString()
		        })
		    })
		    .then(response => response.json())
		    .then(data => {
		        if (data.success) {
		            // 좋아요 상태를 변경합니다.
		            if (isLiked) {
		                likeIcon.classList.remove('bi-heart-fill', 'text-danger');
		                likeIcon.classList.add('bi-heart');
		            } else {
		                likeIcon.classList.remove('bi-heart');
		                likeIcon.classList.add('bi-heart-fill', 'text-danger');
		            }
		        } else {
		            alert('좋아요 등록 실패: ' + data.message);
		        }
		    })
		    .catch(error => {
		        console.error('Error:', error);
		        alert('좋아요 등록 중 오류가 발생했습니다.');
		    });
		}


	    /*]]>*/
	</script>


	</body>
	</html>