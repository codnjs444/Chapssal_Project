<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <style>
		body {
		    background-color: #000;
		    color: #fff;
		    overflow: hidden;
		}
		.video-container {
		    display: flex;
		    height: 100vh;
		    position: relative;
		}
		.video-section {
		    flex: 3;
		    display: flex;
		    justify-content: center;
		    align-items: center;
		    position: relative;
		}
		.video-section video {
		    max-width: 100%;
		    max-height: 100%;
		}
		.info-section {
		    flex: 1;
		    padding: 20px;
		    overflow-y: auto;
		    background-color: #fff;
		    color: #000;
		    position: relative;
		}
		.profile-section, .comments-section {
		    background-color: #f9f9f9;
		    padding: 10px;
		    border-radius: 10px;
		    margin-bottom: 20px;
		}
		.profile-section .follow-btn {
		    color: #fff;
		    background-color: #ff0050;
		    border: none;
		    padding: 5px 20px; /* ë²„íŠ¼ ê¸¸ì´ ì¡°ì • */
		    border-radius: 5px;
		    margin-left: auto;
		}
		.comments-section h6 {
		    margin-bottom: 10px;
		}
		.comment-item {
		    display: flex;
		    margin-bottom: 10px;
		}
		.comment-item img {
		    width: 40px;
		    height: 40px;
		    border-radius: 50%;
		    margin-right: 10px;
		}
		.comment-item .comment-body {
		    flex-grow: 1;
		}
		.close-btn, .navigation-btns {
		    position: absolute;
		    top: 20px;
		    right: 20px;
		    z-index: 1000;
		}
		.navigation-btns {
		    top: 50%;
		    right: 20px;
		    transform: translateY(-50%);
		}
		.navigation-btns button {
		    background: none;
		    border: none;
		    color: white;
		    font-size: 24px;
		    display: block;
		    margin: 10px 0;
		}
		.profile-section img {
		    width: 40px; /* í”„ë¡œí•„ ì‚¬ì§„ í¬ê¸°ë¥¼ ì¤„ì…ë‹ˆë‹¤ */
		    height: 40px; /* í”„ë¡œí•„ ì‚¬ì§„ í¬ê¸°ë¥¼ ì¤„ì…ë‹ˆë‹¤ */
		}
		.profile-info-container {
		    display: flex;
		    align-items: center;
		    flex-grow: 1;
		    margin-left: 10px; /* ì´ë¦„ì„ ì´ë¯¸ì§€ ì˜†ì— ê°€ê¹ê²Œ ë°°ì¹˜ */
		}
		.profile-section h5 {
		    font-size: 1rem; /* ì´ë¦„ í¬ê¸° ì¡°ì ˆ */
		    margin-bottom: 0;
		}
		.profile-section small {
		    display: block; /* í•™êµë¥¼ ì´ë¦„ ì•„ë˜ì— í‘œì‹œ */
		    font-size: 0.8rem; /* í•™êµ ì´ë¦„ í¬ê¸° ì¡°ì ˆ */
		    color: #6c757d; /* í•™êµ ì´ë¦„ ìƒ‰ìƒ ì¡°ì ˆ */
		}
		.comment-input-container {
		    display: flex;
		    align-items: center;
		    padding: 5px;
		    background-color: #f9f9f9;
		    border-radius: 10px;
		    box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
		    position: absolute;
		    bottom: 10px;
		    right: 10px;
		    width: calc(100% - 40px); /* ì „ì²´ ë„ˆë¹„ì—ì„œ ì¢Œìš° ë§ˆì§„ì„ ê³ ë ¤í•œ ë„ˆë¹„ ì„¤ì • */
		}

		.comment-input {
		    flex-grow: 1;
		    border: none;
		    padding: 8px 10px;
		    border-radius: 10px;
		    background-color: #e9ecef;
		    margin-right: 5px;
		}
		.comment-input:focus {
		    outline: none;
		}
		.submit-comment-btn {
		    background-color: transparent;
		    color: #007bff;
		    border: none;
		    cursor: pointer;
		    padding: 0 10px;
		}
    </style>
</head>
<body>
    <div class="video-container">
        <div class="video-section"> 
            <video controls autoplay>
                <source th:src="${videoUrl}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
			<button class="close-btn btn btn-outline-light" id="closeButton" onclick="navigateToProfile()">
			    <i class="bi bi-x"></i>
			</button>
			<div class="navigation-btns">
			    <button th:onclick="'navigateVideo(' + ${nextVideoNum} + ', ' + ${videoUser.userNum} + ')'" th:disabled="${nextVideoNum} == 0">
			        <i class="bi bi-chevron-up"></i>
			    </button>
			    <button th:onclick="'navigateVideo(' + ${prevVideoNum} + ', ' + ${videoUser.userNum} + ')'" th:disabled="${prevVideoNum} == 0">
			        <i class="bi bi-chevron-down"></i>
			    </button>
			</div>
        </div>
        <div class="info-section">
            <div class="profile-section">
				<div class="d-flex align-items-center mb-2">
				    <img th:src="${profilePictureUrl != null ? profilePictureUrl : '/images/default_profile.png'}" class="rounded-circle" alt="í”„ë¡œí•„ ì‚¬ì§„" th:onclick="|navigateToProfilePage(${userNum}, ${currentUserNum})|">
				    <div class="profile-info-container" th:onclick="|navigateToProfilePage(${userNum}, ${currentUserNum})|">
				        <div>
				            <h5 th:text="${userName != null ? userName : 'ì‚¬ìš©ì'}" th:onclick="|navigateToProfilePage(${userNum}, ${currentUserNum})|"></h5>
				            <small th:text="${schoolName}" th:onclick="|navigateToProfilePage(${userNum}, ${currentUserNum})|"></small>
				        </div>
				    </div>
					<button type="button"
					        th:if="${currentUserNum} != ${userNum}"
					        th:classappend="${isFollowing} ? 'btn btn-outline-secondary btn-sm' : 'btn btn-primary btn-sm text-white'"
					        th:attr="onclick=|followUser('${currentUserNum}', '${userNum}', '${isFollowing}')|">
					    <i th:classappend="${isFollowing} ? 'bi bi-check2' : ''"></i>
					    <span th:text="${isFollowing} ? 'íŒ”ë¡œì‰' : 'íŒ”ë¡œìš°'"></span>
					</button>
				</div>
				<p th:text="${videoTitle}"></p>
<!--                <a href="#" class="text-muted">ìì„¸íˆ</a>-->
			<div class="d-flex justify-content-around mt-3">
			    <div class="d-flex align-items-center">
			        <button type="button" class="btn btn-link" 
			                th:classappend="${isLiked} ? 'text-danger' : 'text-muted'"
			                th:attr="onclick=|likeVideo(${videoNum}, ${currentUserNum}, '${isLiked}')|">
			            <i th:classappend="${isLiked} ? 'bi bi-heart-fill' : 'bi bi-heart'"></i>
			        </button>
			        <span class="like-count ms-0" th:text="${likeCount}"></span> <!-- ì¢‹ì•„ìš” ìˆ˜ í‘œì‹œ, ë” ê°€ê¹Œì´ ìœ„ì¹˜ -->
			    </div>
				<div class="d-flex align-items-center">
				    <div><i class="bi bi-chat"></i> 47</div>
				</div>
				<div class="d-flex align-items-center">
				    <div><i class="bi bi-share"></i> 593</div>
				</div>
			</div>
			
            </div>
            <div class="comments-section">
                <h6>ëŒ“ê¸€</h6>
                <div class="comment-item">
                    <img src="https://via.placeholder.com/40" alt="ì‚¬ìš©ì ì‚¬ì§„">
                    <div class="comment-body">
                        <strong>ê¸°ë©”ë ãƒ»í¬ë¦¬ì—ì´í„°</strong>
                        <p>ì•„ë¼ì™€ ì—°ìš° í›„ì† ì´ì•¼ê¸°ëŠ” ë¬´ë”ìš´ ì–´ëŠ ì—¬ë¦„ë‚  ê³µê°œ ì˜ˆì •ì…ë‹ˆë‹¤ ğŸ˜</p>
                        <small>5-9</small>
                    </div>
                </div>
                <div class="comment-item">
                    <img src="https://via.placeholder.com/40" alt="ì‚¬ìš©ì ì‚¬ì§„">
                    <div class="comment-body">
                        <strong>í‚¤ë“œ ìŠ¤í† ì»¤</strong>
                        <p>ë¹¨ë¦¬ì™”ë‹¤!</p>
                        <small>5-9</small>
                    </div>
                </div>
				<div>
				      <p>Video Number: <span id="videoNumDisplay" th:text="${videoNum}"></span></p>
				</div>
            </div>
			<!-- ì¶”ê°€ ëŒ“ê¸€ ì•„ì´í…œ -->
			<div class="comment-input-container">
			    <input type="hidden" name="videoNum" id="videoNum" value="${videoNum}">
			    <input type="hidden" name="currentUserNum" id="currentUserNum" value="${currentUserNum}">
			    <input type="text" class="comment-input" name="commentText" id="commentText" placeholder="ë”°ëœ»í•œ ë§ í•œë§ˆë”” í•´ì£¼ì„¸ìš”...">
			    <button type="button" class="submit-comment-btn" onclick="submitComment()">ê²Œì‹œ</button>
			</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
	<script th:inline="javascript">
	    /*<![CDATA[*/
		
		document.addEventListener('DOMContentLoaded', function() {
		    const videoNum = /*[[${videoNum}]]*/ '[[${videoNum}]]';
		    console.log('Video Number:', videoNum);
		    document.getElementById('videoNumDisplay').textContent = videoNum;
		});
		
	    function followUser(currentUserNum, userNum, isFollowing) {
	        console.log("followUser í•¨ìˆ˜ í˜¸ì¶œë¨");

	        if (isFollowing === 'true') {
	            if (!confirm('íŒ”ë¡œìš°ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
	                return;
	            }
	        }

	        let url = isFollowing === 'true' ? '/follow/unfollow' : '/follow';
	        let method = isFollowing === 'true' ? 'DELETE' : 'POST';

	        fetch(url, {
	            method: method,
	            headers: {
	                'Content-Type': 'application/json'
	            },
	            body: JSON.stringify({
	                follower: currentUserNum,
	                following: userNum
	            })
	        })
	        .then(response => response.json())
	        .then(data => {
	            if (data.success) {
	                location.reload();
	            } else {
	                alert('ì‘ì—… ì‹¤íŒ¨: ' + data.message);
	            }
	        })
	        .catch(error => {
	            console.error('Error:', error);
	            alert('ì‘ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
	        });
	    }

	    function likeVideo(videoNum, currentUserNum, isLiked) {
	        console.log("likeVideo í•¨ìˆ˜ í˜¸ì¶œë¨");

	        let url = isLiked === 'true' ? '/video/unlike' : '/video/like';
	        let method = isLiked === 'true' ? 'DELETE' : 'POST';

	        fetch(url, {
	            method: method,
	            headers: {
	                'Content-Type': 'application/json'
	            },
	            body: JSON.stringify({
	                video: videoNum,
	                user: currentUserNum
	            })
	        })
	        .then(response => response.json())
	        .then(data => {
	            if (data.success) {
	                location.reload();
	            } else {
	                alert('ì‘ì—… ì‹¤íŒ¨: ' + data.message);
	            }
	        })
	        .catch(error => {
	            console.error('Error:', error);
	            alert('ì‘ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
	        });
	    }

	    function navigateVideo(videoNum, userNum) {
	        // ì´ í•¨ìˆ˜ëŠ” ì£¼ì–´ì§„ ë¹„ë””ì˜¤ ë²ˆí˜¸ì™€ ì‚¬ìš©ì ë²ˆí˜¸ë¡œ ì´ë™í•©ë‹ˆë‹¤.
	        if (videoNum === 0) {
	            alert("ë” ì´ìƒì˜ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.");
	        } else {
	            window.location.href = '/video/' + videoNum + '?userNum=' + userNum;
	        }
	    }

		function navigateToProfile() {
		    // ì‚¬ìš©ìì˜ í”„ë¡œí•„ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.
		    const userNum = /*[[${videoUser.userNum}]]*/ [[${videoUser.userNum}]];
		    const currentUserNum = /*[[${currentUserNum}]]*/ [[${currentUserNum}]];
		    
		    if (userNum === currentUserNum) {
		        window.location.href = 'http://localhost:8080/user/profile';
		    } else {
		        window.location.href = 'http://localhost:8080/user/profile/' + userNum;
		    }
		}


		function navigateToProfilePage(userNum, currentUserNum) {
		    // ì‚¬ìš©ìì˜ í”„ë¡œí•„ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.
		    if (userNum === currentUserNum) {
		        window.location.href = 'http://localhost:8080/user/profile';
		    } else {
		        window.location.href = 'http://localhost:8080/user/profile/' + userNum;
		    }
		}

	    document.addEventListener('keydown', function(event) {
	        if (event.key === 'ArrowUp') {
	            // ìœ„ ë°©í–¥í‚¤ë¥¼ ëˆ„ë¥´ë©´ ì´ì „ ë¹„ë””ì˜¤ë¡œ ì´ë™
	            navigateVideo(/*[[${prevVideoNum}]]*/ '[[${prevVideoNum}]]', /*[[${videoUser.userNum}]]*/ '[[${videoUser.userNum}]]');
	        } else if (event.key === 'ArrowDown') {
	            // ì•„ë˜ ë°©í–¥í‚¤ë¥¼ ëˆ„ë¥´ë©´ ë‹¤ìŒ ë¹„ë””ì˜¤ë¡œ ì´ë™
	            navigateVideo(/*[[${nextVideoNum}]]*/ '[[${nextVideoNum}]]', /*[[${videoUser.userNum}]]*/ '[[${videoUser.userNum}]]');
	        } else if (event.key === 'Escape') {
	            // Esc í‚¤ë¥¼ ëˆ„ë¥´ë©´ í”„ë¡œí•„ í˜ì´ì§€ë¡œ ì´ë™
	            navigateToProfile();
	        }
	    });
		
		document.addEventListener('DOMContentLoaded', function() {
		    const videoNum = /*[[${videoNum}]]*/ '[[${videoNum}]]';
		    const currentUserNum = /*[[${currentUserNum}]]*/ '[[${currentUserNum}]]';
		    console.log('Video Number:', videoNum);
		    console.log('Current User Number:', currentUserNum);
		    document.getElementById('videoNumDisplay').textContent = videoNum;
		    document.getElementById('videoNum').value = videoNum;
		    document.getElementById('currentUserNum').value = currentUserNum;
		});

		function submitComment() {
		    const commentText = document.getElementById('commentText').value;
		    const videoNum = document.getElementById('videoNum').value;
		    const currentUserNum = document.getElementById('currentUserNum').value;

		    if (commentText.trim() === "") {
		        alert("ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”.");
		        return;
		    }

		    const comment = {
		        text: commentText,
		        video: { videoNum: parseInt(videoNum, 10) },
		        user: { userNum: parseInt(currentUserNum, 10) }
		    };

		    console.log('Sending comment:', comment);

		    fetch('/comment/add', {
		        method: 'POST',
		        headers: {
		            'Content-Type': 'application/json'
		        },
		        body: JSON.stringify(comment)
		    })
		    .then(response => response.text()) // ì‘ë‹µì„ í…ìŠ¤íŠ¸ë¡œ ì²˜ë¦¬
		    .then(text => {
		        console.log('Response text:', text);
		        if (text.trim() === 'success') {
		            location.reload();
		        } else {
		            alert('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨: ' + text);
		        }
		    })
		    .catch(error => {
		        console.error('Error:', error);
		        alert('ëŒ“ê¸€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
		    });
		}



	    /*]]>*/
	</script>


	</body>
	</html>