<!DOCTYPE html>
<html layout:decorate="~{layout}">
<head>
    <style>
        .video-list {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .video-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 400px; /* 최대 너비 설정 */
            aspect-ratio: 9 / 16; /* 9:16 비율 */
            background-color: black;
            overflow: hidden;
            border-radius: 10px;
        }

        .video-container video {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            transform: translate(-50%, -50%);
        }

        .video-details {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: white;
            display: flex;
            flex-direction: column;
        }

        .video-details-top {
            display: flex;
            align-items: center;
        }

        .video-details img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .video-details p {
            margin: 0;
            font-size: 14px;
        }

        .video-details-name {
            margin-right: 10px;
        }

        .video-title {
            margin-top: 40px; /* 상하 간격 조절 */
        }

        .follow-btn {
            padding: 5px 10px;
            font-size: 12px;
            background-color: #007bff;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 20px; /* 이름으로부터 간격 조정 */
        }

        .follow-btn:hover {
            background-color: #0056b3;
        }

        .video-buttons {
            position: absolute;
            top: 50%;
            right: 80px; /* 영상에서 떨어진 위치 */
            display: flex;
            flex-direction: column;
            transform: translateY(-5%);
        }

        .button-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
        }

        .action-btn {
            background-color: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-bottom: 5px;
        }

        .video-btn-count {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            color: black; /* 텍스트 색상 검정으로 변경 */
            font-weight: bold; /* 폰트 굵게 설정 */
        }

        .nav-center {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .home-nav-link {
            background-color: rgb(100, 100, 100, 0.1);
            color: black;
            width: 108px;
            height: 40px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 15px;
        }

        .home-nav-link.active {
            background-color: black !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <div layout:fragment="content" class="container">
        <nav class="container nav-center p-0">
            <div class="nav nav-pills center" id="nav-tab" role="tablist">
                <button class="nav-link home-nav-link active mx-1 py-1" id="nav-all-tab" data-bs-toggle="pill" data-bs-target="#nav-all" type="button" role="tab" aria-controls="nav-all" aria-selected="true">전체</button>
                <button class="nav-link home-nav-link mx-1 p-0" th:each="topic : ${topicsByVoteCount}" th:id="'nav-' + ${topic[0].topicNum} + '-tab'" data-bs-toggle="pill" th:data-bs-target="'#nav-' + ${topic[0].topicNum}" type="button" role="tab" th:aria-controls="'nav-' + ${topic[0].topicNum}" aria-selected="false" th:text="${topic[0].title}"></button>
            </div>
        </nav>
        <br>
        <br>
        <div class="tab-content" id="nav-tabContent">
            <!-- 전체 탭에서 비디오를 출력하는 부분 -->
            <div class="tab-pane fade show active" id="nav-all" role="tabpanel" aria-labelledby="nav-all-tab" tabindex="0">
                <div class="video-list">
                    <div th:if="${videos != null}">
                        <div th:each="videoData : ${videos}" class="video-item">
                            <div class="video-container" th:data-video-id="${videoData.video.videoNum}" th:data-title="${videoData.video.title}" th:data-username="${videoData.video.user.userName}" th:data-views="${videoData.video.viewCount}" th:data-videourl="${videoData.video.videoUrl}">
                                <video controls autoplay muted>
                                    <source th:src="@{${videoData.video.videoUrl}}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                                <div class="video-details">
                                    <div class="video-details-top">
                                        <img th:src="${videoData.video.user.profilePictureUrl != null ? videoData.video.user.profilePictureUrl : '/images/default_profile.png'}" alt="프로필 사진" class="rounded-circle profile-pic">
                                        <p class="video-details-name" th:text="${videoData.video.user.userName}"></p>
                                        <button class="follow-btn">팔로우</button>
                                    </div>
                                    <p class="video-title" th:text="${videoData.video.title}"></p> <!-- 클래스 추가 -->
                                </div>
                            </div>
                            <div class="video-buttons">
                                <div class="button-container">
                                    <button class="action-btn"><i class="bi bi-heart-fill"></i></button>
                                    <p class="video-btn-count m-0" th:text="${videoData.likeCount}"></p>
                                </div>
                                <div class="button-container">
                                    <button class="action-btn modal-open"><i class="bi bi-chat-dots-fill"></i></button>
                                    <p class="video-btn-count m-0" th:text="${videoData.commentCount}"></p>
                                </div>
                                <div class="button-container">
                                    <button class="action-btn"><i class="bi bi-bookmark-fill"></i></button>
                                    <p class="video-btn-count m-0">362</p>
                                </div>
                                <div class="button-container">
                                    <button class="action-btn"><i class="bi bi-share-fill"></i></button>
                                    <p class="video-btn-count m-0">228</p>
                                </div>
                            </div>
                            <br>
                            <hr style="width: 700px;">
                            <br>
                        </div>
                    </div>
                    <div th:if="${videos == null}">
                        <p>비디오가 없습니다. 비디오를 업로드해주세요.</p>
                    </div>
                </div>
            </div>

            <!-- 각 주제별 탭에서 비디오를 출력하는 부분 -->
            <div th:each="topic : ${topicsByVoteCount}" th:id="'nav-' + ${topic[0].topicNum}" class="tab-pane fade" role="tabpanel" th:aria-labelledby="'nav-' + ${topic[0].topicNum} + '-tab'" tabindex="0">
                <div class="video-list">
                    <div th:each="videoData : ${videos}" th:if="${videoData.video.topic != null and videoData.video.topic == topic[0].topicNum}" class="video-item">
                        <div class="video-container" th:data-video-id="${videoData.video.videoNum}" th:data-title="${videoData.video.title}" th:data-username="${videoData.video.user.userName}" th:data-views="${videoData.video.viewCount}" th:data-videourl="${videoData.video.videoUrl}">
                            <video controls autoplay muted>
                                <source th:src="@{${videoData.video.videoUrl}}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            <div class="video-details">
                                <div class="video-details-top">
                                    <img th:src="${videoData.video.user.profilePictureUrl != null ? videoData.video.user.profilePictureUrl : '/images/default_profile.png'}" alt="프로필 사진" class="rounded-circle profile-pic">
                                    <p class="video-details-name" th:text="${videoData.video.user.userName}"></p>
                                    <button class="follow-btn">팔로우</button>
                                </div>
                                <p class="video-title" th:text="${videoData.video.title}"></p> <!-- 클래스 추가 -->
                            </div>
                            <div class="video-buttons">
                                <div class="button-container">
                                    <button class="action-btn"><i class="bi bi-heart-fill"></i></button>
                                    <p class="video-btn-count m-0" th:text="${videoData.likeCount}"></p>
                                </div>
                                <div class="button-container">
                                    <button class="action-btn modal-open"><i class="bi bi-chat-dots-fill"></i></button>
                                    <p class="video-btn-count m-0" th:text="${videoData.commentCount}"></p>
                                </div>
                                <div class="button-container">
                                    <button class="action-btn"><i class="bi bi-bookmark-fill"></i></button>
                                    <p class="video-btn-count m-0">362</p>
                                </div>
                                <div class="button-container">
                                    <button class="action-btn"><i class="bi bi-share-fill"></i></button>
                                    <p class="video-btn-count m-0">221</p>
                                </div>
                            </div>
                        </div>
                        <br>
                        <hr style="width: 700px;">
                        <br>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 홈 스크립트 -->
    <th:block th:fragment="homeVideoScript">
        <script th:inline="javascript">
            function styleSpecialChars(text) {
                return text.replace(/#(\S+)/g, '<strong>#$1</strong>')
                           .replace(/@(\S+)/g, '<strong>@$1</strong>');
            }
            
            $(document).ready(function() {
                // 모든 video.title 요소를 찾아서 스타일 변경
                $('.video-content p').each(function() {
                    const originalText = $(this).text();
                    const styledText = styleSpecialChars(originalText);
                    $(this).html(styledText);
                });

                let options = {
                    root: null,
                    rootMargin: '0px',
                    threshold: 0.5
                };

                let observer = new IntersectionObserver(function(entries, observer) {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            let video = entry.target.querySelector('video');
                            if (video) {
                                video.play();
                            }
                        } else {
                            let video = entry.target.querySelector('video');
                            if (video) {
                                video.pause();
                            }
                        }
                    });
                }, options);

                document.querySelectorAll('.video-item').forEach(item => {
                    observer.observe(item);
                });

				// Infinite scroll 기능 추가
				//let currentPage = 0;
				//const size = 3;
				//const weekOffset = /*[[${weekOffset}]]*/ 0; // Thymeleaf 변수를 JavaScript로 전달

				/*function loadMoreVideos() {
				    currentPage++;
				    $.ajax({
				        url: '/',
				        method: 'GET',
				        data: {
				            weekOffset: weekOffset,
				            page: currentPage,
				            size: size
				        },
				        success: function(response) {
				            const newVideos = $(response).find('.video-item');
				            $('.video-list').append(newVideos);

				            newVideos.each(function() {
				                observer.observe(this);
				            });
				        },
				        error: function() {
				            currentPage--; // 실패 시 페이지를 다시 감소
				        }
				    });
				}

				$(window).on('scroll', function() {
				    if ($(window).scrollTop() + $(window).height() > $(document).height() - 100) {
				        loadMoreVideos();
				    }
				});*/
				
            });
        </script>
    </th:block>
</body>
</html>
