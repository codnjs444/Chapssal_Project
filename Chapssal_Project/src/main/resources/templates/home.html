<!DOCTYPE html>
<html layout:decorate="~{layout}">
<head>
    <style>
        .video-list {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .video-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 400px; /* 최대 너비 설정 */
            aspect-ratio: 9 / 16; /* 9:16 비율 */
            background-color: black;
            overflow: hidden;
            border-radius: 10px;
        }

        .video-container video {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            transform: translate(-50%, -50%);
            object-fit: cover; /* 비디오가 컨테이너를 덮도록 설정 */
        }

        .video-details {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            color: white;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease; /* 애니메이션 효과 */
            pointer-events: none; /* 마우스 이벤트 무시 */
        }

        .video-container:hover .video-details {
            transform: translateY(-100%); /* 마우스가 올라갔을 때 위로 이동 */
        }

        .video-details-top {
            display: flex;
            align-items: center;
            z-index: 2; /* 비디오 위로 배치 */
            pointer-events: auto; /* 클릭 가능 */
        }

        .video-details img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .video-details p {
            margin: 0;
            font-size: 14px;
        }

        .video-details-name {
            margin-right: 10px;
        }

        .video-title {
            margin-top: 10px; /* 상하 간격 조절 */
        }

        .follow-btn {
            padding: 5px 10px;
            font-size: 12px;
            background-color: #007bff;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer; /* 커서 변경 */
            margin-left: 20px; /* 이름으로부터 간격 조정 */
            z-index: 2; /* 비디오 위로 배치 */
            pointer-events: auto; /* 클릭 가능 */
        }

        .follow-btn:hover {
            background-color: #0056b3;
        }

        .video-buttons {
            position: absolute;
            top: 50%;
            right: 80px; /* 영상에서 떨어진 위치 */
            display: flex;
            flex-direction: column;
            transform: translateY(-5%);
        }

        .button-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
        }

        .action-btn {
            background-color: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-bottom: 5px;
            z-index: 2; /* 비디오 위로 배치 */
            pointer-events: auto; /* 클릭 가능 */
        }

        .video-btn-count {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            color: black; /* 텍스트 색상 검정으로 변경 */
            font-weight: bold; /* 폰트 굵게 설정 */
        }

        .nav-center {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .home-nav-link {
            background-color: rgb(100, 100, 100, 0.1);
            color: black;
            width: 108px;
            height: 40px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 15px;
        }

        .home-nav-link.active {
            background-color: black !important;
            color: white !important;
        }

        /* 커스텀 컨트롤 */
        .custom-controls {
            position: absolute;
            bottom: 10px; /* 동영상 위의 오버레이 위치 */
            left: 10px;
            right: 10px;
            width: calc(100% - 20px); /* 컨트롤의 너비를 비디오에 맞게 */
            display: flex;
            align-items: center;
            justify-content: space-between;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 2; /* 비디오 위로 배치 */
            pointer-events: auto; /* 클릭 가능 */
        }

        .video-container:hover .custom-controls {
            opacity: 1;
        }

        .custom-controls .progress-container {
            flex-grow: 1;
            height: 5px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 5px;
            overflow: hidden;
            margin: 0 10px;
            cursor: pointer;
        }

        .custom-controls .progress-bar {
            width: 0;
            height: 100%;
            background-color: #007bff;
        }

        .custom-controls .play-pause-btn {
            background-color: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div layout:fragment="content" class="container">
        <nav class="container nav-center p-0">
            <div class="nav nav-pills center" id="nav-tab" role="tablist">
                <button class="nav-link home-nav-link active mx-1 py-1" id="nav-all-tab" data-bs-toggle="pill" data-bs-target="#nav-all" type="button" role="tab" aria-controls="nav-all" aria-selected="true">전체</button>
                <button class="nav-link home-nav-link mx-1 p-0" th:each="topic : ${topicsByVoteCount}" th:id="'nav-' + ${topic[0].topicNum} + '-tab'" data-bs-toggle="pill" th:data-bs-target="'#nav-' + ${topic[0].topicNum}" type="button" role="tab" th:aria-controls="'nav-' + ${topic[0].topicNum}" aria-selected="false" th:text="${topic[0].title}"></button>
            </div>
			<input type="hidden" id="currentUserNum" th:value="${currentUserNum}" />
        </nav>
        <br>
        <br>
        <div class="tab-content" id="nav-tabContent">
            <!-- 전체 탭에서 비디오를 출력하는 부분 -->
            <div class="tab-pane fade show active" id="nav-all" role="tabpanel" aria-labelledby="nav-all-tab" tabindex="0">
                <div class="video-list">
                    <div th:if="${videos != null}">
                        <div th:each="videoData : ${videos}" class="video-item">
                            <div class="video-container" th:data-video-id="${videoData.video.videoNum}" th:data-title="${videoData.video.title}" th:data-username="${videoData.video.user.userName}" th:data-views="${videoData.video.viewCount}" th:data-videourl="${videoData.video.videoUrl}">
                                <video autoplay muted loop playsinline>
                                    <source th:src="@{${videoData.video.videoUrl}}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                                <div class="video-details">
                                    <div class="video-details-top">
										<img th:src="${videoData.video.user.profilePictureUrl != null ? videoData.video.user.profilePictureUrl : '/images/default_profile.png'}" alt="프로필 사진" class="rounded-circle profile-pic">
										<p class="video-details-name" th:text="${videoData.video.user.userName}"></p>
                                        <!-- 팔로우 버튼 -->
										<button class="follow-btn" 
										        th:if="${currentUserNum != videoData.video.user.userNum}"
										        th:data-videonum="${videoData.video.videoNum}" 
										        th:data-usernum="${videoData.video.user.userNum}">
										    팔로우
										</button>
                                    </div>
                                    <p class="video-title" th:text="${videoData.video.title}"></p> <!-- 클래스 추가 -->
                                </div>
                                <div class="custom-controls">
                                    <button class="play-pause-btn">⏸️</button> <!-- 기본 상태는 일시정지 아이콘 -->
                                    <div class="progress-container">
                                        <div class="progress-bar"></div>
                                    </div>
                                    <div class="time-display">0:00 / 0:00</div> <!-- 시간 표시 -->
                                </div>
                            </div>
                            <div class="video-buttons">
                                <div class="button-container">
                                    <button class="action-btn"><i class="bi bi-heart-fill"></i></button>
                                    <p class="video-btn-count m-0" th:text="${videoData.likeCount}"></p>
                                </div>
                                <div class="button-container">
                                    <button class="action-btn modal-open"><i class="bi bi-chat-dots-fill"></i></button>
                                    <p class="video-btn-count m-0" th:text="${videoData.commentCount}"></p>
                                </div>
                                <div class="button-container">
                                    <button class="action-btn"><i class="bi bi-bookmark-fill"></i></button>
                                    <p class="video-btn-count m-0">362</p>
                                </div>
                                <div class="button-container">
                                    <button class="action-btn"><i class="bi bi-share-fill"></i></button>
                                    <p class="video-btn-count m-0">228</p>
                                </div>
                            </div>
                            <br>
							
                            <hr style="width: 700px;">
                            <br>
                        </div>
                    </div>
                    <div th:if="${videos == null}">
                        <p>비디오가 없습니다. 비디오를 업로드해주세요.</p>
                    </div>
                </div>
            </div>

            <!-- 각 주제별 탭에서 비디오를 출력하는 부분 -->
            <div th:each="topic : ${topicsByVoteCount}" th:id="'nav-' + ${topic[0].topicNum}" class="tab-pane fade" role="tabpanel" th:aria-labelledby="'nav-' + ${topic[0].topicNum} + '-tab'" tabindex="0">
                <div class="video-list">
                    <div th:each="videoData : ${videos}" th:if="${videoData.video.topic != null and videoData.video.topic == topic[0].topicNum}" class="video-item">
                        <div class="video-container" th:data-video-id="${videoData.video.videoNum}" th:data-title="${videoData.video.title}" th:data-username="${videoData.video.user.userName}" th:data-views="${videoData.video.viewCount}" th:data-videourl="${videoData.video.videoUrl}">
                            <video autoplay muted loop playsinline>
                                <source th:src="@{${videoData.video.videoUrl}}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            <div class="video-details">
                                <div class="video-details-top">
                                    <img th:src="${videoData.video.user.profilePictureUrl != null ? videoData.video.user.profilePictureUrl : '/images/default_profile.png'}" alt="프로필 사진" class="rounded-circle profile-pic">
                                    <p class="video-details-name" th:text="${videoData.video.user.userName}"></p>
									<!-- 팔로우 버튼 -->
									<button class="follow-btn" 
									        th:if="${currentUserNum != videoData.video.user.userNum}"
									        th:data-videonum="${videoData.video.videoNum}" 
									        th:data-usernum="${videoData.video.user.userNum}">
									    팔로우
									</button>
                                </div>
                                <p class="video-title" th:text="${videoData.video.title}"></p> <!-- 클래스 추가 -->
                            </div>
                            <div class="custom-controls">
                                <button class="play-pause-btn">⏸️</button> <!-- 기본 상태는 일시정지 아이콘 -->
                                <div class="progress-container">
                                    <div class="progress-bar"></div>
                                </div>
                                <div class="time-display">0:00 / 0:00</div> <!-- 시간 표시 -->
                            </div>
                            <div class="video-buttons">
                                <div class="button-container">
                                    <button class="action-btn"><i class="bi bi-heart-fill"></i></button>
                                    <p class="video-btn-count m-0" th:text="${videoData.likeCount}"></p>
                                </div>
                                <div class="button-container">
                                    <button class="action-btn modal-open"><i class="bi bi-chat-dots-fill"></i></button>
                                    <p class="video-btn-count m-0" th:text="${videoData.commentCount}"></p>
                                </div>
                                <div class="button-container">
                                    <button class="action-btn"><i class="bi bi-bookmark-fill"></i></button>
                                    <p class="video-btn-count m-0">362</p>
                                </div>
                                <div class="button-container">
                                    <button class="action-btn"><i class="bi bi-share-fill"></i></button>
                                    <p class="video-btn-count m-0">228</p>
                                </div>
                            </div>
                        </div>
                        <br>
                        <hr style="width: 700px;">
                        <br>
                    </div>
                </div>
            </div>
        </div>
    </div>

	<!-- 홈 스크립트 -->
	<th:block th:fragment="homeVideoScript">
		<script>
			$(document).ready(function() {
			    const currentUserNum = $('#currentUserNum').val();

			    // 좋아요 상태를 확인하여 버튼 업데이트
			    $('.video-item').each(function() {
			        const videoItem = $(this);
			        const videoNum = videoItem.find('.video-container').data('video-id');

			        $.ajax({
			            url: '/video/isLiked',
			            type: 'GET',
			            data: {
			                video: videoNum,
			                user: currentUserNum
			            },
			            success: function(response) {
			                updateLikeButton(videoItem, response.isLiked, response.likeCount);
			            },
			            error: function(xhr, status, error) {
			                console.error('좋아요 상태 확인 중 오류 발생:', xhr.responseText);
			            }
			        });
			    });

			    function updateLikeButton(videoItem, isLiked, likeCount) {
			        const likeButton = videoItem.find('.button-container .action-btn i.bi-heart-fill'); // 좋아요 하트 아이콘만 선택
			        const likeCountElem = videoItem.find('.button-container .video-btn-count'); // 좋아요 개수 요소 선택

			        if (isLiked) {
			            likeButton.css('color', '#ff69b4'); // 분홍색으로 변경
			        } else {
			            likeButton.css('color', '#ffffff'); // 흰색으로 변경
			        }

			        // 좋아요 개수 업데이트
			        likeCountElem.text(likeCount);

			        // 클릭 이벤트 바인딩
			        videoItem.find('.button-container .action-btn').off('click').on('click', function() {
			            handleLikeButtonClick(videoItem, isLiked, likeCountElem);
			        });
			    }

			    function handleLikeButtonClick(videoItem, isLiked, likeCountElem) {
			        const videoNum = videoItem.find('.video-container').data('video-id');
			        const url = isLiked ? '/video/unlike' : '/video/like';
			        const method = isLiked ? 'DELETE' : 'POST';
			        const options = {
			            method: method,
			            headers: {
			                'Content-Type': 'application/json'
			            },
			            body: JSON.stringify({
			                video: videoNum,
			                user: currentUserNum
			            })
			        };

			        fetch(url, options)
			        .then(response => {
			            if (!response.ok) {
			                return response.json().then(errorInfo => Promise.reject(errorInfo));
			            }
			            return response.json();
			        })
			        .then(data => {
			            if (data.success) {
			                const currentLikeCount = parseInt(likeCountElem.text()) || 0; // 현재 좋아요 수
			                const newLikeCount = isLiked ? currentLikeCount - 1 : currentLikeCount + 1; // 좋아요 수 업데이트

			                // 좋아요 상태와 좋아요 개수를 함께 업데이트
			                updateLikeButton(videoItem, !isLiked, newLikeCount);

			                alert(isLiked ? '좋아요를 취소하였습니다.' : '좋아요하였습니다.');
			            } else {
			                alert('작업 실패: ' + data.message);
			            }
			        })
			        .catch(error => {
			            console.error('Error:', error);
			            alert('작업 중 오류가 발생했습니다.');
			        });
			    }

		        // 팔로우 상태를 확인하여 버튼 업데이트
		        $('.follow-btn').each(function() {
		            const followBtn = $(this);
		            const userNum = followBtn.attr('data-usernum');

		            $.ajax({
		                url: '/checkFollowStatus',
		                type: 'GET',
		                data: {
		                    currentUserNum: currentUserNum,
		                    userNum: userNum
		                },
		                success: function(isFollowing) {
		                    updateFollowButton(followBtn, isFollowing);
		                },
		                error: function(xhr, status, error) {
		                    console.error('팔로우 상태 확인 중 오류 발생:', xhr.responseText);
		                }
		            });
		        });

		        function updateFollowButton(followBtn, isFollowing) {
		            const userNum = followBtn.attr('data-usernum');
		            const videoNum = followBtn.attr('data-videonum'); // 비디오 번호 추가
		            console.log('updateFollowButton - isFollowing:', isFollowing); // 팔로우 상태 출력
		            if (isFollowing) {
		                followBtn.removeClass('not-following').addClass('following').text('팔로잉').css('background-color', '#ff69b4');
		                followBtn.off('click').on('click', function() {
		                    handleFollowButtonClick(currentUserNum, userNum, videoNum, true); // 팔로우 상태와 함께 전달
		                });
		            } else {
		                followBtn.removeClass('following').addClass('not-following').text('팔로우').css('background-color', '#007bff');
		                followBtn.off('click').on('click', function() {
		                    handleFollowButtonClick(currentUserNum, userNum, videoNum, false); // 팔로우 상태와 함께 전달
		                });
		            }
		        }

		        function handleFollowButtonClick(currentUserNum, userNum, videoNum, isFollowing) {
		            console.log('handleFollowButtonClick - currentUserNum:', currentUserNum);
		            console.log('handleFollowButtonClick - userNum:', userNum);
		            console.log('handleFollowButtonClick - videoNum:', videoNum);
		            console.log('handleFollowButtonClick - isFollowing:', isFollowing);
		            followUserHome(currentUserNum, userNum, isFollowing);
		        }

		        function followUserHome(currentUserNum, userNum, isFollowing) {
		            let url = isFollowing ? `/followHome/unfollow?follower=${currentUserNum}&following=${userNum}` : '/followHome';
		            let method = isFollowing ? 'DELETE' : 'POST';
		            let options = {
		                method: method,
		                headers: {
		                    'Content-Type': 'application/json'
		                }
		            };

		            if (method === 'POST') {
		                options.body = JSON.stringify({
		                    follower: currentUserNum,
		                    following: userNum
		                });
		            }

		            fetch(url, options)
		            .then(response => {
		                if (!response.ok) {
		                    return response.json().then(errorInfo => Promise.reject(errorInfo));
		                }
		                return response.json();
		            })
		            .then(data => {
		                if (data.success) {
		                    const followButton = $(`.follow-btn[data-usernum="${userNum}"]`);
		                    if (isFollowing) {
		                        followButton.removeClass('following').addClass('not-following').text('팔로우').css('background-color', '#007bff');
		                        followButton.off('click').on('click', function() {
		                            followUserHome(currentUserNum, userNum, false); // 팔로우 상태와 함께 전달
		                        });
		                    } else {
		                        followButton.removeClass('not-following').addClass('following').text('팔로잉').css('background-color', '#ff69b4');
		                        followButton.off('click').on('click', function() {
		                            followUserHome(currentUserNum, userNum, true); // 팔로우 상태와 함께 전달
		                        });
		                    }
		                    alert(isFollowing ? '팔로우를 취소하였습니다.' : '팔로우하였습니다.');
		                } else {
		                    alert('작업 실패: ' + data.message);
		                }
		            })
		            .catch(error => {
		                console.error('Error:', error);
		                alert('작업 중 오류가 발생했습니다.');
		            });
		        }

		        // 동영상 재생 및 일시정지 기능 추가
		        const videoContainers = document.querySelectorAll('.video-container');

		        videoContainers.forEach(container => {
		            const video = container.querySelector('video');
		            const playPauseButton = container.querySelector('.play-pause-btn');

		            // 비디오가 클릭될 때 재생 및 일시정지 기능
		            video.addEventListener('click', () => {
		                if (video.paused) {
		                    video.play().catch(error => {
		                        console.error('비디오 재생 오류:', error);
		                    });
		                    playPauseButton.innerText = '⏸️';
		                } else {
		                    video.pause();
		                    playPauseButton.innerText = '▶️';
		                }
		            });

		            // playPauseButton 클릭 시 재생 및 일시정지
		            playPauseButton.addEventListener('click', () => {
		                if (video.paused) {
		                    video.play().catch(error => {
		                        console.error('비디오 재생 오류:', error);
		                    });
		                    playPauseButton.innerText = '⏸️';
		                } else {
		                    video.pause();
		                    playPauseButton.innerText = '▶️';
		                }
		            });

		            // 비디오 재생 시 playPauseButton 업데이트
		            video.addEventListener('play', () => {
		                playPauseButton.innerText = '⏸️';
		            });

		            // 비디오 일시정지 시 playPauseButton 업데이트
		            video.addEventListener('pause', () => {
		                playPauseButton.innerText = '▶️';
		            });

		            // 비디오 재생 시간 업데이트
		            video.addEventListener('timeupdate', () => {
		                const progressBar = container.querySelector('.progress-bar');
		                const timeDisplay = container.querySelector('.time-display');
		                const currentTime = video.currentTime;
		                const duration = video.duration;

		                if (progressBar) {
		                    const progress = (currentTime / duration) * 100;
		                    progressBar.style.width = `${progress}%`;
		                }

		                if (timeDisplay) {
		                    const formatTime = (time) => {
		                        const minutes = Math.floor(time / 60);
		                        const seconds = Math.floor(time % 60);
		                        return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
		                    };
		                    timeDisplay.innerText = `${formatTime(currentTime)} / ${formatTime(duration)}`;
		                }
		            });

		            // 비디오 컨트롤바 클릭 시 시간 변경
		            const progressContainer = container.querySelector('.progress-container');
		            if (progressContainer) {
		                progressContainer.addEventListener('click', (e) => {
		                    const rect = progressContainer.getBoundingClientRect();
		                    const offsetX = e.clientX - rect.left;
		                    const newTime = (offsetX / rect.width) * video.duration;
		                    video.currentTime = newTime;
		                });
		            }
		        });
		    });
		</script>


	</th:block>

</body>
</html>