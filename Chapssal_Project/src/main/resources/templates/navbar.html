<head>
<style>
    body {
        font-size: 15px; /* 기본 폰트 크기를 설정 */
    }

    .list-group-item-action {
        cursor: pointer;
    }

	#hashtagSuggestions,
	#userSuggestions {
	    position: absolute;
	    z-index: 1000;
	    background-color: white;
	    width: 100%;
	    max-height: 200px;
	    overflow-y: auto;
	    border: 1px solid #ccc;
	    border-radius: 5px;
	}
</style>
</head>
<div th:fragment="navbarFragment" class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
    <div class="container-fluid">
        <a class="navbar-brand" href="/"><img th:src="${'/images/chapssal_logo.png'}" style="width: 96px; height: 54px;"></a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <form class="d-flex ms-auto" role="search" style="width: 35%; margin-left: 20%;">
				<input id="searchInput" class="form-control rounded-pill me-2" type="search" placeholder="검색" aria-label="Search">
				<div id="searchSuggestions" class="list-group position-absolute" style="z-index: 1000;"></div>
				<button class="btn btn-outline-success rounded-pill" type="submit">
				    <i class="bi bi-search"></i>
				</button>
            </form>
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                <li class="nav-item" sec:authorize="isAuthenticated()">
                    <div class="upload-container" data-bs-toggle="modal" data-bs-target="#uploadModal">
                        <span class="upload-text">업로드</span>
                        <button class="upload-button">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                </li>
                <li class="nav-item" sec:authorize="isAuthenticated()">
                    <a class="nav-link center-icon"  th:href="@{/message/home}"><i class="bi bi-envelope-open"></i></a>
                </li>
				<!-- 알림 아이콘 -->
				<li class="nav-item" sec:authorize="isAuthenticated()">
				    <a class="nav-link center-icon notification-icon" href="#" onclick="toggleNotifications()">
				        <i class="bi bi-bell"></i>
				        <span id="notificationCount" class="badge bg-danger" style="display: none;"></span>
				    </a>
				</li>
                <li class="nav-item">
                    <a class="nav-link" sec:authorize="isAnonymous()" th:href="@{/user/login}">로그인</a>
                </li>
                <li class="nav-item" sec:authorize="isAnonymous()">
                    <a class="nav-link" th:href="@{/user/signup}">회원가입</a>
                </li>
            </ul>
        </div>
    </div>
</div>

<!-- 모달 컴포넌트를 별도의 프래그먼트로 분리 -->
<div th:fragment="uploadModalFragment">
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="height: 85%;">
            <div class="modal-content" style="height:85%;">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadModalLabel">업로드</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="overflow-y: auto;">
                    <!-- 파일 업로드 폼 -->
                    <form id="uploadForm" method="post" action="/video/upload" enctype="multipart/form-data" onsubmit="return prepareThumbnail()">
                        <div class="mb-3">
                            <label for="file" class="form-label">파일 업로드</label>
                            <!-- 드래그 앤 드롭 영역 -->
                            <div id="dropZone" class="border border-secondary p-3 text-center">
                                파일을 여기에 드래그 앤 드롭 하세요
                            </div>
                            <input type="file" name="file" class="form-control d-none" id="fileInput" accept="video/*" required>
                        </div>
                        <!-- 비디오 미리보기 -->
                        <div id="previewContainer" class="mt-3 position-relative" style="height: 250px;"> <!-- 높이를 약간 줄임 -->
                            <label for="videoPreview" class="form-label">미리보기</label>
                            <div id="emptyPreview" class="w-100 h-90 border border-secondary" style="height: 200px;"></div> <!-- 높이를 약간 줄임 -->
                            <video id="videoPreview" controls class="w-100 h-100 position-absolute top-50 start-50 translate-middle" style="display: none;">
                                <source id="videoSource" src="" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>
						<div class="mb-3">
						    <label for="title" class="form-label">내용</label>
						    <input type="text" name="title" class="form-control" id="title" required>
						    <div id="hashtagSuggestions" class="list-group position-absolute" style="z-index: 1000;"></div>
							<div id="userSuggestions" class="list-group position-absolute" style="z-index: 1000;"></div>
						</div>
                        <div class="mb-3">
                            <label for="topic" class="form-label">주제</label>
                            <select name="topic" class="form-control" id="topic" required>
								<option th:each="topic : ${topicsByVoteCount}" th:value="${topic[0].topicNum}" th:text="${topic[0].title}"></option>
                            </select>
                        </div>
                        <input type="hidden" name="thumbnail" id="thumbnailInput">
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                            <button type="submit" class="btn btn-primary">업로드</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 스크립트를 별도의 프래그먼트로 분리 -->
<th:block th:fragment="uploadModalScript">
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var uploadModal = new bootstrap.Modal(document.getElementById('uploadModal'), {
                backdrop: true
            });

            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            const previewContainer = document.getElementById('previewContainer');
            const emptyPreview = document.getElementById('emptyPreview');
            const videoPreview = document.getElementById('videoPreview');
            const videoSource = document.getElementById('videoSource');
            const thumbnailCanvas = document.createElement('canvas'); // 썸네일 캔버스를 동적으로 생성
            const thumbnailInput = document.getElementById('thumbnailInput');

            // 전체 문서에서 드래그 앤 드롭 이벤트 기본 동작 및 전파 막기
            function preventDefaults(event) {
                event.preventDefault();
                event.stopPropagation();
            }

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                document.addEventListener(eventName, preventDefaults, false);
            });

            dropZone.addEventListener('dragover', (event) => {
                preventDefaults(event);
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', (event) => {
                preventDefaults(event);
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (event) => {
                preventDefaults(event);
                dropZone.classList.remove('dragover');
                const files = event.dataTransfer.files;
                fileInput.files = files;

                // 파일 이름과 용량 표시 및 미리보기 설정
                if (files.length > 0) {
                    const file = files[0];
                    displayFileNameAndSize(file);
                    previewVideo(file);
                }
            });

            dropZone.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', () => {
                // 파일 이름과 용량 표시 및 미리보기 설정
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    displayFileNameAndSize(file);
                    previewVideo(file);
                }
            });

            function displayFileNameAndSize(file) {
                const fileSize = formatFileSize(file.size);
                dropZone.textContent = `${file.name} (${fileSize})`;
            }

            function formatFileSize(size) {
                if (size < 1024) {
                    return `${size} bytes`;
                } else if (size < 1024 * 1024) {
                    return `${(size / 1024).toFixed(1)} KB`;
                } else {
                    return `${(size / (1024 * 1024)).toFixed(1)} MB`;
                }
            }

            function previewVideo(file) {
                const fileURL = URL.createObjectURL(file);
                videoSource.src = fileURL;
                videoPreview.load();
                emptyPreview.style.display = 'none';
                videoPreview.style.display = 'block';
                previewContainer.style.display = 'block';

                videoPreview.addEventListener('loadeddata', () => {
                    videoPreview.currentTime = 0;
                    captureThumbnail(); // 영상의 첫 프레임을 기본 썸네일로 캡처
                });

                videoPreview.addEventListener('timeupdate', () => {
                    captureThumbnail(); // 비디오 재생 위치가 변경될 때마다 썸네일 캡처
                });
            }

            function captureThumbnail() {
                const context = thumbnailCanvas.getContext('2d');
                thumbnailCanvas.width = videoPreview.videoWidth;
                thumbnailCanvas.height = videoPreview.videoHeight;
                context.drawImage(videoPreview, 0, 0, videoPreview.videoWidth, videoPreview.videoHeight);
                thumbnailCanvas.toBlob((blob) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(blob);
                    reader.onloadend = () => {
                        thumbnailInput.value = reader.result;
                    };
                }, 'image/jpeg', 0.7); // JPEG로 변환하고 품질을 70%로 설정하여 파일 크기를 줄임
            }

            window.prepareThumbnail = function() {
                if (!fileInput.files.length || !thumbnailInput.value) {
                    alert("Please select a file and set a thumbnail.");
                    return false;
                }
                return true;
            };
					
		    const titleInput = document.getElementById('title');
		    const hashtagSuggestions = document.getElementById('hashtagSuggestions');
		    const userSuggestions = document.getElementById('userSuggestions');

		    // 제목 입력 시 해시태그 및 사용자 이름 자동완성 기능 추가
		    titleInput.addEventListener('input', function() {
		        const query = this.value;
		        const hashtagIndex = query.lastIndexOf('#');
		        const userIndex = query.lastIndexOf('@');

		        // 해시태그 자동완성
		        if (hashtagIndex !== -1 && (userIndex === -1 || hashtagIndex > userIndex)) {
		            const hashtagQuery = query.substring(hashtagIndex + 1);
		            if (hashtagQuery.length > 0) {
		                $.ajax({
		                    url: '/hashtag/suggestions',
		                    method: 'GET',
		                    data: { query: hashtagQuery },
		                    success: function(data) {
		                        hashtagSuggestions.innerHTML = '';
		                        data.forEach(function(item) {
		                            const suggestionItem = document.createElement('a');
		                            suggestionItem.href = '#';
		                            suggestionItem.classList.add('list-group-item', 'list-group-item-action', 'suggestion-item');
		                            suggestionItem.textContent = `#${item.tag}`;
		                            hashtagSuggestions.appendChild(suggestionItem);
		                        });
		                    }
		                });
		            } else {
		                $.ajax({
		                    url: '/hashtag/suggestions',
		                    method: 'GET',
		                    data: { query: '' },
		                    success: function(data) {
		                        hashtagSuggestions.innerHTML = '';
		                        data.forEach(function(item) {
		                            const suggestionItem = document.createElement('a');
		                            suggestionItem.href = '#';
		                            suggestionItem.classList.add('list-group-item', 'list-group-item-action', 'suggestion-item');
		                            suggestionItem.textContent = `#${item.tag}`;
		                            hashtagSuggestions.appendChild(suggestionItem);
		                        });
		                    }
		                });
		            }
		        } else {
		            hashtagSuggestions.innerHTML = '';
		        }

		        // 사용자 이름 자동완성
		        if (userIndex !== -1 && (hashtagIndex === -1 || userIndex > hashtagIndex)) {
		            const userQuery = query.substring(userIndex + 1);
		            if (userQuery.length > 0) {
		                $.ajax({
		                    url: '/user/suggestions',
		                    method: 'GET',
		                    data: { query: userQuery },
		                    success: function(data) {
		                        userSuggestions.innerHTML = '';
		                        data.forEach(function(item) {
		                            const suggestionItem = document.createElement('a');
		                            suggestionItem.href = '#';
		                            suggestionItem.classList.add('list-group-item', 'list-group-item-action', 'suggestion-item');
		                            suggestionItem.textContent = `@${item.userName}`;
		                            userSuggestions.appendChild(suggestionItem);
		                        });
		                    }
		                });
		            } else {
		                userSuggestions.innerHTML = '';
		            }
		        } else {
		            userSuggestions.innerHTML = '';
		        }
		    });

		    // 자동완성 항목 클릭 시 입력창에 해당 값 설정
		    hashtagSuggestions.addEventListener('click', function(e) {
		        if (e.target.classList.contains('suggestion-item')) {
		            e.preventDefault();
		            const query = titleInput.value;
		            const hashtagIndex = query.lastIndexOf('#');
		            titleInput.value = query.substring(0, hashtagIndex) + e.target.textContent + ' ';
		            hashtagSuggestions.innerHTML = '';
		        }
		    });

		    userSuggestions.addEventListener('click', function(e) {
		        if (e.target.classList.contains('suggestion-item')) {
		            e.preventDefault();
		            const query = titleInput.value;
		            const userIndex = query.lastIndexOf('@');
		            titleInput.value = query.substring(0, userIndex) + e.target.textContent + ' ';
		            userSuggestions.innerHTML = '';
		        }
		    });

		    // 입력창에서 벗어나면 추천 기능 사라지게 하기
		    document.addEventListener('click', function(e) {
		        if (!e.target.closest('#title, #searchInput, #hashtagSuggestions, #userSuggestions, #searchSuggestions')) {
		            hashtagSuggestions.innerHTML = '';
		            userSuggestions.innerHTML = '';
		        }
		    });
		});
    </script>
</th:block>

<!-- 알림 패널을 별도의 프래그먼트로 분리 -->
<div th:fragment="notificationPanelFragment">
    <div id="notificationPanel" class="notification-panel">
        <div class="notification-header">
            <h5>알림</h5>
            <button type="button" class="btn-close" aria-label="Close" onclick="toggleNotifications()"></button>
        </div>
        <div class="notification-body">
            <ul id="notificationList">
                <!-- 알림 항목이 여기에 추가됩니다 -->
                <li id="notification-[[${notification.notiNum}]]" th:each="notification : ${notifications}">
                    <span>
                        <a th:href="@{'/user/profile/' + ${notification.sender.userNum}}" class="notification-user-link" th:text="${notification.sender.userName}">사용자 이름</a>님이 당신을 팔로우했습니다.
                    </span>
                    <button th:onclick="'confirmNotification(' + ${notification.notiNum} + ')'" >확인</button>
                </li>
            </ul>
        </div>
    </div>
</div>

<!-- 알림 패널 스크립트를 별도의 프래그먼트로 분리 -->
<th:block th:fragment="notificationPanelScript">
    <script>
		document.addEventListener('DOMContentLoaded', function() {
		    function toggleNotifications() {
		        var panel = document.getElementById('notificationPanel');
		        if (panel.classList.contains('active')) {
		            panel.classList.remove('active');
		        } else {
		            panel.classList.add('active');
		        }
		    }

		    // 알림 아이콘 클릭 시 알림 패널 표시/숨김
		    document.querySelector('.notification-icon').addEventListener('click', function (event) {
		        event.stopPropagation();
		        toggleNotifications();
		    });

		    // 다른 영역 클릭 시 알림 패널 숨기기
		    document.addEventListener('click', function(event) {
		        var panel = document.getElementById('notificationPanel');
		        if (!panel.contains(event.target) && panel.classList.contains('active')) {
		            panel.classList.remove('active');
		        }
		    });

		    // 알림 패널 안에서 클릭할 경우 이벤트 전파 중지
		    document.getElementById('notificationPanel').addEventListener('click', function(event) {
		        event.stopPropagation();
		    });

		    fetch('/notifications/unread')
		        .then(response => response.json())
		        .then(data => {
		            var count = document.getElementById('notificationCount');
		            count.innerText = data.length;
		            count.style.display = data.length > 0 ? 'block' : 'none';

		            var notificationList = document.getElementById('notificationList');
		            notificationList.innerHTML = '';  // 기존 알림 리스트를 초기화
		            data.forEach(notification => {
		                addNotification(notification);
		            });
		        })
		        .catch(error => console.error('Error fetching unread notifications:', error));

		    function addNotification(notification) {
		        var notificationList = document.getElementById('notificationList');
		        var listItem = document.createElement('li');
		        listItem.id = 'notification-' + notification.notiNum;

		        var messageSpan = document.createElement('span');
		        messageSpan.innerHTML = `<a href="/user/profile/${notification.sender.userNum}" class="notification-user-link">${notification.sender.userName}</a>님이 당신을 팔로우했습니다.`;

		        var confirmButton = document.createElement('button');
		        confirmButton.textContent = '확인';
		        confirmButton.onclick = function() {
		            confirmNotification(notification.notiNum);
		            listItem.remove();
		            updateNotificationCount();
		        };

		        listItem.appendChild(messageSpan);
		        listItem.appendChild(confirmButton);
		        notificationList.appendChild(listItem);

		        // 새로 추가된 링크에도 클릭 이벤트 핸들러 추가
		        listItem.querySelector('.notification-user-link').addEventListener('click', function(event) {
		            document.getElementById('notificationPanel').classList.remove('active');
		        });
		    }

		    function confirmNotification(notificationId) {
		        fetch('/notifications/mark-as-read/' + notificationId, {
		            method: 'POST'
		        }).then(response => {
		            if (!response.ok) {
		                console.error('Error marking notification as read');
		            }
		        });
		    }

		    function updateNotificationCount() {
		        var countElement = document.getElementById('notificationCount');
		        var count = parseInt(countElement.innerText);

		        if (count > 0) {
		            count--;
		            countElement.innerText = count;

		            if (count === 0) {
		                countElement.style.display = 'none';
		            }
		        }
		    }
		});

    </script>
</th:block>
