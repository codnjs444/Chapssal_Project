<div th:fragment="navbarFragment" class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
       <div class="container-fluid">
           <a class="navbar-brand" href="/"><img th:src="@{/images/chapssal_logo.png}" style="width: 96px; height: 54px;"></a>
           <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
               aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
               <span class="navbar-toggler-icon"></span>
           </button>

           <div class="collapse navbar-collapse" id="navbarSupportedContent">
               <form class="d-flex ms-auto" role="search" style="width: 35%; margin-left: 20%;">
                   <input class="form-control rounded-pill me-2" type="search" placeholder="검색" aria-label="Search">
                   <button class="btn btn-outline-success rounded-pill" type="submit">
                       <i class="bi bi-search"></i>
                   </button>
               </form>
               <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                   <li class="nav-item" sec:authorize="isAuthenticated()">
                       <div class="upload-container">
                           <span class="upload-text">업로드</span>
                           <button class="upload-button" data-bs-toggle="modal" data-bs-target="#uploadModal">
                               <i class="bi bi-plus"></i>
                           </button>
                       </div>
                   </li>
                   <li class="nav-item" sec:authorize="isAuthenticated()">
                       <a class="nav-link center-icon" th:href="@{/message/home}"><i class="bi bi-envelope-open"></i></a>
                   </li>
                   <!-- 알림 아이콘 -->
                   <li class="nav-item" sec:authorize="isAuthenticated()">
                       <a class="nav-link center-icon notification-icon" href="#">
                           <i class="bi bi-bell"></i>
                           <span id="notificationCount" class="badge bg-danger" style="display: none;"></span>
                       </a>
                   </li>
                   <li class="nav-item" sec:authorize="isAnonymous()">
                       <a class="nav-link" th:href="@{/user/login}">로그인</a>
                   </li>
                   <li class="nav-item" sec:authorize="isAnonymous()">
                       <a class="nav-link" th:href="@{/user/signup}">회원가입</a>
                   </li>
               </ul>
           </div>
       </div>
   </div>

<!-- 모달 컴포넌트를 별도의 프래그먼트로 분리 -->
<div th:fragment="uploadModalFragment">
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="max-height: 80vh;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadModalLabel">업로드</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="overflow-y: auto;">
                    <!-- 파일 업로드 폼 -->
                    <form id="uploadForm" method="post" action="/video/upload" enctype="multipart/form-data" onsubmit="return prepareThumbnail()">
                        <div class="mb-3">
                            <label for="fileInput" class="form-label">파일 업로드</label>
                            <!-- 드래그 앤 드롭 영역 -->
                            <div id="dropZone" class="border border-secondary p-3 text-center">
                                파일을 여기에 드래그 앤 드롭 하세요
                            </div>
                            <input type="file" name="file" class="form-control d-none" id="fileInput" accept="video/*" required>
                        </div>
                        <!-- 비디오 미리보기 -->
                        <div id="previewContainer" class="mt-3 position-relative" style="height: 250px;"> <!-- 높이를 약간 줄임 -->
                            <label for="videoPreview" class="form-label">미리보기</label>
                            <div id="emptyPreview" class="w-100 h-90 border border-secondary" style="height: 200px;"></div> <!-- 높이를 약간 줄임 -->
                            <video id="videoPreview" controls class="w-100 h-100 position-absolute top-50 start-50 translate-middle" style="display: none;">
                                <source id="videoSource" src="" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                        <div class="mb-3">
                            <label for="title" class="form-label">내용</label>
                            <input type="text" name="title" class="form-control" id="title" required>
                        </div>
                        <div class="mb-3">
                            <label for="topic" class="form-label">주제</label>
                            <select name="topic" class="form-control" id="topic" required>
                                <option value="1">주제 1</option>
                                <option value="2">주제 2</option>
                                <!-- 추가 주제 옵션들 -->
                            </select>
                        </div>
                        <input type="hidden" name="thumbnail" id="thumbnailInput">
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                            <button type="submit" class="btn btn-primary">업로드</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 스크립트를 별도의 프래그먼트로 분리 -->
<th:block th:fragment="uploadModalScript">
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var uploadModal = new bootstrap.Modal(document.getElementById('uploadModal'), {
                backdrop: true
            });

            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            const previewContainer = document.getElementById('previewContainer');
            const emptyPreview = document.getElementById('emptyPreview');
            const videoPreview = document.getElementById('videoPreview');
            const videoSource = document.getElementById('videoSource');
            const thumbnailCanvas = document.createElement('canvas'); // 썸네일 캔버스를 동적으로 생성
            const thumbnailInput = document.getElementById('thumbnailInput');

            // 전체 문서에서 드래그 앤 드롭 이벤트 기본 동작 및 전파 막기
            function preventDefaults(event) {
                event.preventDefault();
                event.stopPropagation();
            }

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                document.addEventListener(eventName, preventDefaults, false);
            });

            dropZone.addEventListener('dragover', (event) => {
                preventDefaults(event);
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', (event) => {
                preventDefaults(event);
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (event) => {
                preventDefaults(event);
                dropZone.classList.remove('dragover');
                const files = event.dataTransfer.files;
                fileInput.files = files;

                // 파일 이름과 용량 표시 및 미리보기 설정
                if (files.length > 0) {
                    const file = files[0];
                    displayFileNameAndSize(file);
                    previewVideo(file);
                }
            });

            dropZone.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', () => {
                // 파일 이름과 용량 표시 및 미리보기 설정
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    displayFileNameAndSize(file);
                    previewVideo(file);
                }
            });

            function displayFileNameAndSize(file) {
                const fileSize = formatFileSize(file.size);
                dropZone.textContent = `${file.name} (${fileSize})`;
            }

            function formatFileSize(size) {
                if (size < 1024) {
                    return `${size} bytes`;
                } else if (size < 1024 * 1024) {
                    return `${(size / 1024).toFixed(1)} KB`;
                } else {
                    return `${(size / (1024 * 1024)).toFixed(1)} MB`;
                }
            }

            function previewVideo(file) {
                const fileURL = URL.createObjectURL(file);
                videoSource.src = fileURL;
                videoPreview.load();
                emptyPreview.style.display = 'none';
                videoPreview.style.display = 'block';
                previewContainer.style.display = 'block';

                videoPreview.addEventListener('loadeddata', () => {
                    videoPreview.currentTime = 0;
                    captureThumbnail(); // 영상의 첫 프레임을 기본 썸네일로 캡처
                });

                videoPreview.addEventListener('timeupdate', () => {
                    captureThumbnail(); // 비디오 재생 위치가 변경될 때마다 썸네일 캡처
                });
            }

            function captureThumbnail() {
                const context = thumbnailCanvas.getContext('2d');
                thumbnailCanvas.width = videoPreview.videoWidth;
                thumbnailCanvas.height = videoPreview.videoHeight;
                context.drawImage(videoPreview, 0, 0, videoPreview.videoWidth, videoPreview.videoHeight);
                thumbnailCanvas.toBlob((blob) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(blob);
                    reader.onloadend = () => {
                        thumbnailInput.value = reader.result;
                    };
                }, 'image/jpeg', 0.7); // JPEG로 변환하고 품질을 70%로 설정하여 파일 크기를 줄임
            }

            window.prepareThumbnail = function() {
                if (!fileInput.files.length || !thumbnailInput.value) {
                    alert("Please select a file and set a thumbnail.");
                    return false;
                }
                return true;
            };
        });
    </script>
</th:block>

<!-- 알림 패널 -->
<div th:fragment="notificationPanelFragment">
	<div id="notificationPanel" class="notification-panel" style="display: none; position: absolute; right: 10px; top: 60px; background-color: white; border: 1px solid #ddd; padding: 10px; width: 400px;">
	    <div class="notification-header">
	        <h5>알림</h5>
	        <button type="button" class="btn-close" aria-label="Close" onclick="toggleNotifications()"></button>
	    </div>
	    <div class="notification-body">
	        <ul class="nav nav-tabs">
	            <li class="nav-item">
	                <a id="allTab" class="nav-link active" href="#" onclick="showNotifications('all')">모든 활동</a>
	            </li>
	            <li class="nav-item">
	                <a id="likeVideoTab" class="nav-link" href="#" onclick="showNotifications('like_video')">좋아요</a>
	            </li>
	            <li class="nav-item">
	                <a id="followTab" class="nav-link" href="#" onclick="showNotifications('follow')">팔로우</a>
	            </li>
	        </ul>
	        <ul id="notificationList" class="mt-3">
	            <!-- 알림 항목이 여기에 추가됩니다 -->
	        </ul>
	        <!-- 알림이 없을 때 표시할 아이콘과 텍스트 -->
	        <div id="noNotifications" class="text-center mt-5" style="display: none;">
	            <i class="bi bi-bell-slash" style="font-size: 3rem; color: #aaa;"></i>
	            <p class="mt-3">계정에 대한 알림은 여기에 표시됩니다.</p>
	        </div>
	    </div>
	</div>
</div>

<!-- 알림 패널 스크립트를 별도의 프래그먼트로 분리 -->
<th:block th:fragment="notificationPanelScript">
    <style>
		.notification-panel {
		    font-family: Arial, sans-serif;
		}

		.notification-header h6 {
		    font-size: 14px;
		    margin: 0;
		}

		.notification-body .nav-tabs .nav-link {
		    color: #000;
		    font-size: 12px;
		    border: none;
		    border-bottom: 2px solid transparent;
		}

		.notification-body .nav-tabs .nav-link.active {
		    font-weight: bold;
		    border-bottom: 2px solid #000; /* 검정색 구분선 */
		}

		.notification-body ul {
		    padding: 0;
		    list-style: none;
		    margin-top: 10px;
		}

		.notification-body ul li {
		    padding: 5px 0;
		    border-bottom: 1px solid #eee;
		    display: flex;
		    align-items: center;
		}

		.notification-body ul li span {
		    font-size: 12px;
		}

		.notification-body ul li button {
		    font-size: 10px;
		    padding: 2px 5px;
		    margin-left: 10px;
		    border: none;
		    background-color: #007bff;
		    color: white;
		    border-radius: 3px;
		}

		.notification-body ul li button:hover {
		    background-color: #0056b3;
		}

		.notification-profile-image {
		    width: 30px;
		    height: 30px;
		    object-fit: cover;
		}

		.notification-tooltip {
		    position: absolute;
		    top: 30px;
		    right: 0;
		    background-color: #fff;
		    border: 1px solid #ddd;
		    border-radius: 5px;
		    padding: 10px;
		    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
		    z-index: 1000;
		    width: 320px;
		    display: none;
		}

		.notification-tooltip::after {
		    content: '';
		    position: absolute;
		    bottom: -10px;
		    right: 10px;
		    border-width: 10px;
		    border-style: solid;
		    border-color: #fff transparent transparent transparent;
		}


    </style>
    <script>
		document.addEventListener('DOMContentLoaded', function() {
		    function toggleNotifications() {
		        var panel = document.getElementById('notificationPanel');
		        if (panel.style.display === 'none' || panel.style.display === '') {
		            panel.style.display = 'block';
		        } else {
		            panel.style.display = 'none';
		        }
		    }

		    document.querySelector('.notification-icon').addEventListener('click', function(event) {
		        event.stopPropagation();
		        toggleNotifications();
		    });

		    document.addEventListener('click', function(event) {
		        var panel = document.getElementById('notificationPanel');
		        if (!panel.contains(event.target) && panel.style.display === 'block') {
		            panel.style.display = 'none';
		        }
		    });

		    document.getElementById('notificationPanel').addEventListener('click', function(event) {
		        event.stopPropagation();
		    });

		    fetch('/notifications/unread')
		        .then(response => response.json())
		        .then(data => {
		            var count = document.getElementById('notificationCount');
		            count.innerText = data.length;
		            count.style.display = data.length > 0 ? 'block' : 'none';

		            updateNotificationList(data);
		        })
		        .catch(error => console.error('Error fetching unread notifications:', error));

		    const eventSource = new EventSource('/notifications/stream');
		    eventSource.onmessage = function(event) {
		        const notification = JSON.parse(event.data);
		        addNotification(notification);
		        updateNotificationCount(1);
		        // 실시간 알림이 도착했을 때 3초 동안 화면에 표시
		        showAlert('', generateMessage(notification));
		    };

			function addNotification(notification) {
			    var notificationList = document.getElementById('notificationList');
			    var noNotifications = document.getElementById('noNotifications');
			    noNotifications.style.display = 'none';

			    var listItem = document.createElement('li');
			    listItem.id = 'notification-' + notification.notiNum;

			    var messageSpan = document.createElement('span');
			    switch (notification.type.toLowerCase()) {
			        case 'follow':
			            messageSpan.innerHTML = `<a href="/user/profile/${notification.sender.userNum}" class="notification-user-link"><img src="${notification.sender.profilePictureUrl}" class="rounded-circle" style="width: 30px; height: 30px;"> ${notification.sender.userName}</a>님이 당신을 팔로우했습니다.`;
			            break;
			        case 'like_video':
			            messageSpan.innerHTML = `<a href="/user/profile/${notification.sender.userNum}" class="notification-user-link"><img src="${notification.sender.profilePictureUrl}" class="rounded-circle" style="width: 30px; height: 30px;"> ${notification.sender.userName}</a>님이 <a href="/video/${notification.video.videoNum}?userNum=${notification.user.userNum}" class="video-link">당신의 동영상</a>을 좋아합니다.`;
			            break;
			        default:
			            messageSpan.innerHTML = `알 수 없는 알림 유형입니다.`;
			            break;
			    }

			    var confirmButton = document.createElement('button');
			    confirmButton.textContent = '확인';
			    confirmButton.onclick = function() {
			        confirmNotification(notification.notiNum);
			        listItem.remove();
			        updateNotificationCount(-1);
			    };

			    listItem.appendChild(messageSpan);
			    listItem.appendChild(confirmButton);
			    notificationList.appendChild(listItem);

			    var userLink = listItem.querySelector('.notification-user-link');
			    if (userLink) {
			        userLink.addEventListener('click', function(event) {
			            document.getElementById('notificationPanel').style.display = 'none';
			        });
			    }
			}



		    function confirmNotification(notificationId) {
		        fetch('/notifications/mark-as-read/' + notificationId, {
		            method: 'POST'
		        }).then(response => {
		            if (!response.ok) {
		                console.error('Error marking notification as read');
		            } else {
		                document.querySelectorAll(`[id^='notification-']`).forEach(function(element) {
		                    if (element.id.includes(notificationId)) {
		                        element.remove();
		                    }
		                });
		            }
		        });
		    }

		    function updateNotificationCount(change) {
		        var countElement = document.getElementById('notificationCount');
		        var count = parseInt(countElement.innerText);

		        count += change;
		        countElement.innerText = count;

		        countElement.style.display = count > 0 ? 'block' : 'none';
		    }

		    function showAlert(title, message) {
		        const notificationIcon = document.querySelector('.notification-icon');
		        const tooltip = document.createElement('div');
		        tooltip.className = 'notification-tooltip';
		        tooltip.innerHTML = `<strong>${title}</strong> ${message}`;
		        notificationIcon.appendChild(tooltip);
		        tooltip.style.display = 'block';

		        setTimeout(() => {
		            tooltip.remove();
		        }, 3000); // 3초 후에 알람을 자동으로 제거
		    }

		    function generateMessage(notification) {
		        switch (notification.type.toLowerCase()) {
		            case 'follow':
		                return `${notification.sender.userName}님이 당신을 팔로우했습니다.`;
		            case 'like_video':
		                return `${notification.sender.userName}님이 당신의 동영상을 좋아합니다.`;
		            default:
		                return `알 수 없는 알림 유형입니다.`;
		        }
		    }

		    function updateNotificationList(notifications) {
		        var notificationList = document.getElementById('notificationList');
		        var noNotifications = document.getElementById('noNotifications');
		        notificationList.innerHTML = '';

		        if (notifications.length === 0) {
		            noNotifications.style.display = 'block';
		        } else {
		            noNotifications.style.display = 'none';
		            notifications.forEach(notification => {
		                addNotification(notification);
		            });
		        }
		    }

		    window.showNotifications = function(type) {
		        fetch('/notifications/unread')
		            .then(response => response.json())
		            .then(data => {
		                if (type === 'all') {
		                    updateNotificationList(data);
		                } else {
		                    const filteredNotifications = data.filter(notification => notification.type.toLowerCase() === type.toLowerCase());
		                    updateNotificationList(filteredNotifications);
		                }
		            })
		            .catch(error => console.error('Error fetching notifications:', error));
		    };

		    window.toggleNotifications = toggleNotifications; // toggleNotifications 함수를 전역으로 설정
		});


    </script>
</th:block>

